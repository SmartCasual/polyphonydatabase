<h1>Edit composer</h1>
<button onclick="myFunction()" class="help">Show/hide help</button>
<div id="adminhelp"> <u>Some important things to remember when cataloguing</u>:
<ul>
  <li>For the sake of consistency, please use the 'From year' field for single 'flourished' dates.</li>
  <li>Use modern names for birth/death towns. A list of translations from Latin can be found <a href="http://www.catholic-history.org.uk/latin_names.htm">here</a>.</li>
  <li>The 'aliases' field lists all catalogued varations on the composer's name. You can add to this manually too by separating new aliases with a pipe |. Everything in this box will be scanned by the search box on the public table. Deleting existing aliases can cause all sorts of trouble, so please don't do that.</li>
  <li>If you need mre boxes for editions and recordings, save the page and more will magically reappear.</li>
  <li>A quirk of the way the data is structured means you have to save the functions on each piece <strong>one at a time</strong>. I have put some javascript in there to make the selection a bit easier at least!</li>
</ul>
</div>
<%= form_tag("/admin/composers/switch-to", class: "composer-select") do %>
  <%= select_tag "id", options_from_collection_for_select(Composer.all.order(:name), :id, :name, params[:id]) %>

  <button>Edit</button>
<% end %>

<%= form_for([:admin, @composer], builder: ActionView::Helpers::FormBuilder) do |f| %>
<div class="composerbasics">
  <div class="left">
    <label>Name:</label><div class="name"><%= f.text_field :name %></div>

  <div class="image-url-image"><%= image_tag @composer.image_url if @composer.image_url %></div>
  <label>Image URL:</label><div class="image-url"><%= f.text_field :image_url %></div>
  </div>
  <div class="right">
  <div class="dates">
    <div class="prefix">
    Dates:
    <%= f.text_field :from_year_annotation %>
    <%= f.text_field :from_year %>
    </div>
    <div class="prefix">
    to
    <%= f.text_field :to_year_annotation %>
    <%= f.text_field :to_year %>
    </div>
  </div>

  <div class="birthplace">
    <label>Birthplace:</label>
    <%= f.text_field :birthplace_1 %>
    <%= f.text_field :birthplace_2 %>
  </div>

  <div class="deathplace">
    <label>Deathplace:</label>
    <%= f.text_field :deathplace_1 %>
    <%= f.text_field :deathplace_2 %>
  </div>

  <div class="aliases">
    <label>Aliases:</label>:
    <%= f.text_area :aliased_as %>
  </div>
  </div>
</div>
  <button class="save">Save</button>
<% end %>

<table class="unique-pieces">
  <tr>
    <th class="title">Title</th>
    <th class="functions">Function(s)</th>
    <th class="editions">Editions</th>
    <th class="recordings">Recordings</th>
    <th class="sources">Sources</th>
    <th></th>
  </tr>

  <% @grouped_inclusions.sort_by {|up, _| up.title }.each do |unique_piece, inclusions| %>
      <tr>
        <%= form_for([:admin, unique_piece], builder: ActionView::Helpers::FormBuilder) do |f| %>
          <td class="title"><%= f.text_area :title %></td>
          <td class="functions"><%= f.select :feasts, Feast::FEASTS.map { |k, v| [v, k] }, {}, {class: "select2", multiple: true} %></td>
          <td class="editions">
            <%= f.fields_for(:editions, builder: ActionView::Helpers::FormBuilder) do |r| %>
              <div class="edition">
                <%= r.text_field :voicing, placeholder: "Voicing" %>
                <%= r.text_field :editor, placeholder: "Editor" %>
                <%= r.text_field :file_url, placeholder: "File URL" %>
              </div>
            <% end %>
          </td>
          <td class="recordings">
            <%= f.fields_for(:recordings, builder: ActionView::Helpers::FormBuilder) do |r| %>
              <div class="recording">
                <%= r.text_field :performer, placeholder: "Performer" %>
                <%= r.text_field :file_url, placeholder: "File URL" %>
              </div>
            <% end %>
          </td>
          <td>
            <table class="sources">
              <% inclusions.sort_by {|i| i.from_year || 0}.each do |inclusion| %>
                <tr class="source">
                  <% source = inclusion.source %>
                  <td class="dates"><%= source.dates %></td>
                  <td class="source-name"><%= link_to source.code, edit_admin_source_path(source), target: "_blank" %></td>
                  <td class="position"><%= inclusion.position %></td>
                  <td class="notes"><%= inclusion.notes %></td>
                </tr>
              <% end %>
            </table>
          </td>
          <td>
            <%= hidden_field_tag :composer_id, @composer.id %>
            <%= f.hidden_field :composers %>
            <%= f.hidden_field :minimum_voices %>
            <%= hidden_field_tag :inclusion_ids, inclusions.map(&:id).join(",") %>
            <button class="save">Save</button>
          </td>
        <% end %>
      </tr>
  <% end %>
</table>

<div class="maintable">
  <table class="sortable">
    <tr>
      <th class="title">Title</th>
      <th class="function">Function(s)</th>
      <th class="composers">Composer</th>
      <th class="minimum-voices">#</th>
      <th class="sources">Sources</th>
      <th class="edition">
        <div class="performing-editions">
          Editions
        </div>
        <div class="editor-and-voicing">
          Editor (voicing)
        </div>
      </th>
      <th class="recording">Listen</th>
    </tr>

    <% @unique_pieces.each do |piece| %>
      <tr>
        <td class="title"><%= piece.title %></td>
        <td class="functions"><%= piece.feast_names.join(", ") %></td>
        <td class="composers">
          <% piece.composers.each do |composer| %>
            <div class="composer">
              <div class="name"><%= composer&.name %></div>

              <% if composer %>
                <div class="dates"><%= composer.dates %></div>
              <% end %>
            </div>
          <% end %>
        </td>
        <td class="minimum-voices"><%= piece.minimum_voices %></td>
        <td class="sources">
          <table>
            <% piece.inclusions.sort_by {|i| i.from_year || 0}.each do |inclusion| %>
              <tr>
                <% source = inclusion.source %>
                <% source_name = "#{truncate(source.title, length: 40)} (#{source.code})" %>
                <td class="source-name">
                  <div>
                    <% if source.url.present? %>
                      <%= link_to source_name, source.url, target: "_blank" %>
                    <% else %>
                      <%= source_name %>
                    <% end %>
                  </div>

                  <div class="source-text">
                    <%= [source.location_and_pubscribe, source.dates].reject(&:blank?).join(", ") %>
                    <em>(<%= [source.format, source.type].reject(&:blank?).join(", ") %>)</em>
                    <%= link_to "RISM", source.rism_link, target: "_blank" if source.rism_link.present? %>
                  </div>
                </td>
                <td class="position"><%= inclusion.position %></td>
                <td class="clefs">
                  <% ClefsInclusion.sort(inclusion.clefs_inclusions).each do |ci| %>
                    <%= image_tag "clefs/#{ci.note_for_image}.png", alt: ci.note_for_image, class: "clef-image #{'missing' if ci.missing?} #{'partial' if ci.partial?} #{'transitional' if ci.transitional?}" %>
                  <% end %>
                </td>
                <td class="notes"><%= inclusion.public_notes %></td>
              </tr>
            <% end %>
          </table>
        </td>
        <td class="editions">
          <% piece.editions.each do |edition| %>
            <div class="edition">
              <% edition_text = "#{edition.editor} (#{edition.voicing})" %>
              <% if edition.file_url.present? %>
                <%= link_to edition.file_url, target: "_blank" do %>
                  <%= image_tag "pdf.png" %>
                  <%= edition_text %>
                <% end %>
              <% else %>
                <%= edition_text %>
              <% end %>
            </div>
          <% end %>
        </td>
        <td class="recordings">
          <% piece.recordings.each do |recording| %>
            <% if recording.file_url.present? %>
              <div class="recording">
                <%= link_to recording.file_url, target: "_blank" do %>
                  <%= image_tag "listen.png" %>
                  <%= recording.performer_name %>
                <% end %>
              </div>
            <% end %>
          <% end %>
        </td>
      </tr>
    <% end %>
  </table>
</div>

<h1>The Polyphony Database</h1>
<div class="wrapper">
<button onclick="myFunction()" class="help">Show/hide help</button>
<div id="topexplanation">
  Welcome to the Polyphony Database, the new free resource for early music enthusiasts and musicologists. There's not much to see here at the moment, but check back soon as we'll be adding new things every day.
  <br><br>
  <u>Some notes on filtering</u>:
  <br>
  <ul>
    <li><b>Search</b> looks through all titles, composers (including variant spellings and aliases), source titles, editions, and performers.</li>
    <li><b>Functions</b> list particularly appropriate times to perform sacred music liturgically.</li>
    <li><b>Countries</b> refer to the modern day country in which the composer was born.</li>
    <li><b># Voices</b> doesn't count partial voices (e.g. an extra voice in the second Agnus Dei of a mass setting).</li>
    <li><b>Sources</b> are named to match their RISM classification (prints) or library shelf mark (MSS). A full list of library sigla can be found <a href="http://www.rism.info/en/sigla.html">here</a></li>
    <li>Ticking <b>Edition</b> or <b>Recording</b> will just show pieces with free PDF downloads and performances respectively.</li>
  </ul>
  <br>
 <u>Some notes on the display table</u>:
  <br>
  <ul>
    <li><b>Sources</b> lists all currently catalogued sources for a given piece, each linked to facsimile images of the original at one of the many digital libraries online.</li>
    <li>The clefs are sorted high-to-low and can be partial (greyed out) which denotes those only present for a small portion of a piece or incomplete (red box) which means a voice is missing in the original and needs to be reconstructd by an editor.</li>
    <li>You might also see some clefs with a small blue clef to their right. This represents a part with a large range that is primarily in the large clef but has a significant portion written out in the blue clef.</li>
    <li>N.B. Functions, clef, and detailed source notes are hidden if you're browsing on a small screen, but can still be filtered.</li>
    <li>The RISM link takes you to the corresponding source at the website for the RÃ©pertoire International des Sources Musicales, which has more detailed information on extant copies.</li>
  </ul>
  <br>
  This hobby project is an altruistic venture and free for anyone to use. If you want to print and use an edition, please don't remove any editorial credits or make any changes without consulting the editor - and do get in touch as we love to hear about the music we love being performed!
  <br><br>
  If you would like to help with the cataloguing, donate some money or time to the cause, or pay to commission the cataloguing or editing of anything in particular, please contact Francis at <a href="mailto:francis@prestopublications.co.uk">francis@prestopublications.co.uk</a>
  </div>
<div class="filters">
<%= form_tag root_path, method: :get do %>
  <%= text_field_tag :q, params[:q], placeholder: "Search...", class: "search" %>
  <%= select_tag :function, options_for_select(Feast::FEASTS.map { |k, v| [v, k] }, params[:function]), include_blank: "All functions", class: "functions" %>
  <%= select_tag :composer, options_from_collection_for_select(Composer.all.order(:name), :id, :name, params[:composer]), include_blank: "All composers", class: "composer" %>
  <%= select_tag :composer_country, options_from_collection_for_select(Composer.select(:birthplace_2).distinct.where.not(birthplace_2: [nil, ""]).order(:birthplace_2), :birthplace_2, :birthplace_2, params[:composer_country]), include_blank: "All countries", class: "composer-country" %>
  <%= select_tag :voices, options_from_collection_for_select(UniquePiece.select(:minimum_voices).distinct.order(:minimum_voices), :minimum_voices, :minimum_voices, params[:voices]), include_blank: "All # voices", class: "minimum-voices" %>
  <%= select_tag :source, options_from_collection_for_select(Source.all.order(:code), :id, :code, params[:source]), include_blank: "All sources", class: "source" %>
  <label class="edition">
    Edition
    <%= check_box_tag :has_edition, "1", params[:has_edition] == "1" %>
  </label>
  <label class="recording">
    Recording
    <%= check_box_tag :has_recording, "1", params[:has_recording] == "1" %>
  </label>
  <button class="filter">Filter</button>
<% end %>
</div>
<div class="maintable">
<table class="sortable">
  <tr>
    <th class="title">Title</th>
    <th class="function">Function(s)</th>
    <th class="composers">Composer</th>
    <th class="minimum-voices">#</th>
    <th class="sources">Sources</th>
    <th class="edition">
      <div class="performing-editions">
        Editions
      </div>
      <div class="editor-and-voicing">
        Editor (voicing)
      </div>
    </th>
    <th class="recording">Listen</th>
  </tr>

  <% @grouped_inclusions.each do |unique_piece, inclusions| %>
    <tr>
      <td class="title"><%= unique_piece.title %></td>
      <td class="functions"><%= unique_piece.feast_names.join(", ") %></td>
      <td class="composers">
        <% inclusions.first.composers.each do |composer| %>
          <div class="composer">
            <div class="name"><%= composer&.name %></div>

            <% if composer %>
              <div class="dates"><%= composer.dates %></div>
            <% end %>
          </div>
        <% end %>
      </td>
      <td class="minimum-voices"><%= unique_piece.minimum_voices %></td>
      <td class="sources">
        <table>
          <% inclusions.sort_by {|i| i.from_year || 0}.each do |inclusion| %>
            <tr>
              <% source = inclusion.source %>
              <% source_name = "#{truncate(source.title, length: 40)} (#{source.code})" %>
              <td class="source-name">
                <div>
                  <% if source.url.present? %>
                    <%= link_to source_name, source.url, target: "_blank" %>
                  <% else %>
                    <%= source_name %>
                  <% end %>
                </div>

                <div class="source-text">
                  <%= [source.location_and_pubscribe, source.dates].reject(&:blank?).join(", ") %>
                  <em>(<%= [source.format, source.type].reject(&:blank?).join(", ") %>)</em>
                  <%= link_to "RISM", source.rism_link, target: "_blank" if source.rism_link.present? %>
                </div>
              </td>
              <td class="position"><%= inclusion.position %></td>
              <td class="clefs">
                <% ClefsInclusion.sort(inclusion.clefs_inclusions).each do |ci| %>
                  <%= image_tag "clefs/#{ci.note_for_image}.png", alt: ci.note_for_image, class: "clef-image #{'missing' if ci.missing?} #{'partial' if ci.partial?} #{'transitional' if ci.transitional?}" %>
                <% end %>
              </td>
              <td class="notes"><%= inclusion.public_notes %></td>
            </tr>
          <% end %>
        </table>
      </td>
      <td class="editions">
        <% unique_piece.editions.each do |edition| %>
          <div class="edition">
            <% edition_text = "#{edition.editor} (#{edition.voicing})" %>
            <% if edition.file_url.present? %>
              <%= link_to edition.file_url, target: "_blank" do %>
                <%= image_tag "pdf.png" %>
                <%= edition_text %>
              <% end %>
            <% else %>
              <%= edition_text %>
            <% end %>
          </div>
        <% end %>
      </td>
      <td class="recordings">
        <% unique_piece.recordings.each do |recording| %>
          <% if recording.file_url.present? %>
            <div class="recording">
              <%= link_to recording.file_url, target: "_blank" do %>
                <%= image_tag "listen.png" %>
                <%= recording.performer_name %>
              <% end %>
            </div>
          <% end %>
        <% end %>
      </td>
    </tr>
  <% end %>
</table>
</div>
</div>
